<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd">


    <!-- 1.配置SecurityManager-->
    <bean id="securityManager" class="org.apache.shiro.web.mgt.DefaultWebSecurityManager">
        <!-- 1.1. 认证器-->
        <property name="authenticator" ref="authenticator"/>
        <!-- 1.2. 授权器-->
        <property name="authorizer" ref="authorizer"/>
        <!-- 1.3. session管理器-->
        <property name="sessionManager" ref="sessionManager"/>
    </bean>

    <!-- 1.1. 认证器-->
    <bean id="authenticator" class="org.apache.shiro.authc.pam.ModularRealmAuthenticator">
        <!--认证策略-->
        <property name="authenticationStrategy">
            <bean class="org.apache.shiro.authc.pam.AtLeastOneSuccessfulStrategy"/>
        </property>
        <!--realms-->
        <property name="realms">
            <list>
                <!--2.引用realm-->
                <ref bean="realm"/>
            </list>
        </property>
    </bean>

    <!-- 1.2. 授权器-->
    <bean id="authorizer" class="org.apache.shiro.authz.ModularRealmAuthorizer">
        <!--2.引用realm-->
        <property name="realms">
            <list>
                <ref bean="realm"/>
            </list>
        </property>
    </bean>

    <!-- 1.3. session管理器-->
    <bean id="sessionManager" class="net.wanho.Shiro.session.ShiroSessionManager">

        <!-- 1.3.1. 客户端的ID管理-->
        <property name="sessionIdCookie" >
            <bean class="org.apache.shiro.web.servlet.SimpleCookie">
                <property name="name" value="uid"/>
                <property name="path" value="/"/>
                <property name="maxAge" value="1800"/>
                <property name="httpOnly" value="false"/>
            </bean>
        </property>
        <!-- 1.3.2. 服务session持久化-->
        <property name="sessionDAO" ref="shiroSessionDao" />

        <!-- 1.3.3. 定义session工厂，默认创建SimpleSession-->
        <property name="sessionFactory">
            <bean class="net.wanho.Shiro.session.ShiroSessionFactory"/>
        </property>
    </bean>

    <bean id="shiroSessionDao" class="net.wanho.Shiro.dao.ShiroSessionDao"/>

    <!-- 2.配置realm-->
    <bean id="realm" class="net.wanho.Shiro.realm.ShiroRelam">
        <property name="name" value="wanhorelam"/>
        <property name="credentialsMatcher">
            <bean class="org.apache.shiro.authc.credential.HashedCredentialsMatcher">
                <property name="hashAlgorithmName" value="md5"/>
                <property name="hashIterations" value="1024"/>
            </bean>
        </property>
        <!--2.1. 缓存管理器-->
        <property name="cacheManager">
            <bean class="net.wanho.Shiro.cache.RedisCacheManager"></bean>
        </property>
    </bean>

    <!-- 3.配置LifecycleBeanPostProcessor。可以自已来调用配置在Spring IOC容器中shirobean的生命周期方法-->
    <bean id="lifecycleBeanPostProcessor" class="org.apache.shiro.spring.LifecycleBeanPostProcessor"/>

    <!-- 4.配置shiroFilter：id必须和DelegatingFilterProxy的<filter-name>一致-->
    <bean id="shiroFilter" class="org.apache.shiro.spring.web.ShiroFilterFactoryBean">
        <property name="securityManager" ref="securityManager"/>
        <property name="loginUrl" value="/login.html"/>
        <property name="filters">
            <map>
                <!--验证码过滤器-->
                <entry key="kaptcha">
                    <bean class="net.wanho.Shiro.filter.KaptchaFilter"></bean>
                </entry>
                <!--退出过滤-->
                <entry key="logout">
                    <bean class="net.wanho.Shiro.filter.LogoutFilter"></bean>
                </entry>
            </map>
        </property>

        <property name="filterChainDefinitions">
            <value>
                /login.html=anon
                /sys/user/login=kaptcha
                /img/**=anon
                /js/**=anon
                /css/**=anon
                /sys/user/logout=logout
                /fonts/**=anon
                /kaptcha/kaptchaImage=anon
                /**=authc
            </value>
        </property>


    </bean>

</beans>